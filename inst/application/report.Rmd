---
pagetitle: "PIPprofileR repport"
output:
  html_document:
    includes:
      in_header: rmarkdown/header.html
      after_body: rmarkdown/bottom.html
    toc: true
    toc_float: true
    
params:
  si: NA
  genomes : NA
  plot : NA
  windows : NA
  annotationTable: NA
  pipSTAT : NA
---
```{css, echo=FALSE}

h1 {
  font-size: 25px;
  background-color: #337ab7;
    padding: 5px 10px;
  color: white;
  font-weight: bold;
}

h2 {
  color: #337ab7;
    font-weight: bold;
}

```

# PIP profiles

*Click on the image to enlarge it*

```{r  echo = F, warning = FALSE, message = FALSE, out.width = "100%", out.extra='id="PIPprofIMG"', fig.asp = 0.25, fig.width = 20, dpi = 200}

if(!is.na(params$annotationTable)){
  params$pipSTAT$plot
} else {
  params$plot
}

```

# PIP exploration

```{r echo = F , out.width = "100%"}
inter = params$pipSTAT$dt

DT::datatable(inter, rownames = FALSE,  container = params$pipSTAT$sketch,  colnames = c('', colnames(inter)[-1]),
              selection = 'none',escape = F, extensions = 'Buttons',
              options = list( 
                dom = 'BfRrltpi', 
                autoWidth=TRUE,
                paging=T, 
                scrollX = T,
                fixedColumns = list(leftColumns = c(1,2)), 
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print')),
) %>%
  formatStyle(
    'Color',
    width='20px',
    `font-size` ="1px",
    color = styleEqual(
      inter$Color, inter$Color
    ),
    backgroundColor = styleEqual(
      inter$Color, inter$Color
    )
  ) %>% formatRound(3:ncol(inter), 2)

```

# Information
## Resume

**Reference sequence name** : `r names(params$genomes$genomesNto1$reference)`

**Reference sequence size** : `r nchar(params$genomes$genomesNto1$reference)`

```{r echo = F , out.width = "100%"}

if(params$genomes$genomesNto1$seqType == "DNA"){
  HTML("<p><b>Sequence Type </b>:  Nucleic acid sequence</p>")
} else {
  HTML("<p><b>Sequence Type </b>: Protein sequence</p>")
}

```

**Type of alignment** : `r params$genomes$genomesNto1$pairwiseType` 

**Mean size of query sequences** : `r round(mean(unlist(lapply(params$genomes$genomesNto1$alignments, nchar))))` 

**Number of query sequences** : `r length(params$genomes$genomesNto1$alignments)` 

**Type of alignment** : `r params$genomes$genomesNto1$pairwiseType` 

## Sequence information

```{r echo = F, warning = FALSE, message = FALSE, out.width = "100%"}
if(is.null(params$genomes$SummarySequence)){
  if(params$genomes$seqType == "DNA"){
    resInter  = do.call("rbind", lapply(params$genomes$genomesNto1$sequences, function(s){
      c(Size = nchar(s), (table(unlist(strsplit(as.character(s),"")))/nchar(s)) * 100)
    }))
    
  } else {
    suppressMessages(suppressWarnings(library(seqinr)))
    
    resInter <- do.call("rbind", lapply(params$genomes$genomesNto1$sequences, function(s){
      
      statInter = AAstat(unlist(strsplit(as.character(s), "")), plot = F)
      vectInter = setNames(rep(0, 31),
                           c("Pi", "Tiny","Small","Aliphatic" ,"Aromatic","Non.polar", "Polar","Charged","Basic","Acidic",
                             "*","A","C","D","E","F","G","H","I","K","L","M","N","P","Q","R","S","T","V","W","Y"))
      
      vectInter[names(statInter$Compo)] = statInter$Compo
      vectInter[names(unlist(statInter$Prop))] = round(unlist(statInter$Prop), 2)
      vectInter["Pi"] = round(statInter$Pi, 2)
      vectInter = c(Size = nchar(s), vectInter)
    }))
    
    detach(package:seqinr)
    
    resInter
  }
  datatable(resInter, extensions = 'Buttons', options = list(dom = 'BfRrltpi',scrollX = TRUE, 
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
} else {
  datatable(params$genomes$SummarySequence, extensions = 'Buttons', options = list(dom = 'BfRrltpi',scrollX = TRUE, 
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
}

```

```{r echo = F , out.width = "100%"}
if(params$genomes$genomesNto1$seqType == "DNA"){
  HTML("<h2>Annotation</h2>")
}
```

```{r echo = F , out.width = "100%"}
if(params$genomes$genomesNto1$seqType == "DNA"){
  datatable(params$annotationTable[, 1:(ncol(params$annotationTable)-3)], escape = F, extensions = 'Buttons', options = list(dom = 'BfRrltpi',scrollX = TRUE, 
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
}
```

## Alignments

### Resume

```{r  echo = F, out.width = "100%"}
datatable(params$genomes$genomesNto1$stats %>%  arrange(desc(score)), extensions = 'Buttons', options = list(dom = 'BfRrltpi',scrollX = TRUE, 
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

### Distribution

```{r  echo = F, out.width = "100%"}
if(!is.null(params$plotlyRV$plotGG_scorePlot)){
  params$plotlyRV$plotGG_scorePlot
} else {
  inter = cbind.data.frame(name = rownames(params$genomes$genomesNto1$stats), 
                           score = round(params$genomes$genomesNto1$stats$score))
  inter = inter[order(inter$score, decreasing = TRUE), ]
  inter$name <- factor(inter$name, levels = inter$name)
  
  ggplot(data=inter, aes(x=name, y=score)) +
    geom_bar(stat="identity", fill="steelblue")+
    geom_text(aes(label=score), vjust=-0.3, size=3.5)+
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(title="Score distribution",
         x ="Species", y = "Score")
}

```

```{r  echo = F, out.width = "100%"}

if(!is.null(params$plotlyRV$plotGG_pidPlot)){
  params$plotlyRV$plotGG_pidPlot
} else {
  inter = cbind.data.frame(name = rownames(params$genomes$genomesNto1$stats), 
                           pid = round(params$genomes$genomesNto1$stats$pid))
  inter = inter[order(inter$pid, decreasing = TRUE), ]
  inter$name <- factor(inter$name, levels = inter$name)
  
  ggplot(data=inter, aes(x=name, y=pid)) +
    geom_bar(stat="identity", fill="steelblue")+
    geom_text(aes(label=pid), vjust=-0.3, size=3.5)+
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(title="PID distribution",
         x ="Species", y = "PID")
}

```

# Session Information

In this section is gathered all the information concerning the working 
environment, the versions of the packages used ... to be able to reproduce the analyses.

## R session information and parameters
The versions of the R software and Bioconductor packages used for this analysis are listed below. 
It is important to save them if one wants to re-perform the analysis in the same conditions.

```{r  echo = F}
sessionInfo()
```

